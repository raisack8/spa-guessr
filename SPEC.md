# SpaGuessr 機能仕様書

本書はSpaGuessrの機能仕様を定義します。技術的な実装詳細は [TECH_SPEC.md](./TECH_SPEC.md) を参照してください。

## 1. プロダクト概要

### 1.1 コンセプト
日本の温泉宿の画像を見て、所在地を推測するWebゲーム。**GeoGuessrのプレイ感を完全に模倣**した温泉版として、温泉地の知識を楽しく学習できるプラットフォーム。

### 1.2 GeoGuessrからの模倣要素
以下の要素を**完全に模倣**してプレイ感を統一します：

#### UI・操作感
- **分割画面レイアウト**: 左側に画像、右側に地図（GeoGuessrと同じ配置）
- **地図の操作感**: ズーム、パン、ピン配置の操作感を完全に模倣
- **コンパス表示**: 方向を示すコンパス（Classic + New両方表示オプション）
- **移動コントロール**: 画像内での移動操作（矢印キー、クリック移動）
- **タイマー表示**: 右上に経過時間を表示
- **スコア表示**: 5000点満点制（距離による点数計算）

#### ゲームフロー
- **ラウンド制**: 1ゲーム = 5ラウンド（温泉宿5つ）
- **即座の結果表示**: ピン配置後、即座に結果とスコアを表示
- **ラウンド間の画面**: 結果確認後、「次のラウンドへ」ボタン
- **最終スコア画面**: 全ラウンド終了後の合計スコア表示

#### 操作・設定
- **Movement設定**: 画像内移動の有無を設定可能
- **Pan設定**: 360度回転の有無を設定可能
- **Zoom設定**: ズームイン・アウトの有無を設定可能
- **Time Limit設定**: 制限時間の設定（無制限〜30秒）

**GeoGuessrとの類似点**:
- ランダムな場所が表示される
- 地図上にピンを刺して推測
- 距離に基づくスコアリング
- 5ラウンド制（将来実装）
- 直感的な操作性とUI
- 競技性のある体験

### 1.3 目的
- **学習**: 温泉地の知識を楽しく学習
- **収益化**: 楽天トラベルのアフィリエイト収益
- **エンゲージメント**: ユーザーの継続利用促進

### 1.4 ターゲットユーザー
- **温泉好き**: 温泉地に詳しい人、これから知りたい人
- **地理好き**: 地理的知識を楽しみたい人
- **ゲーマー**: クイズ・推理系ゲームが好きな人

## 2. ゲーム仕様

### 2.1 基本ゲームフロー

#### 2.1.1 ゲーム開始（GeoGuessr同様）
1. **スタート画面**: 「ゲームを始める」ボタンを押下
2. **ローディング**: 温泉宿をランダムで選択
3. **ゲーム画面**: 左側に画像、右側に日本地図を表示

**GeoGuessrスタイルの実装**:
- 大きな「PLAY」ボタンを画面中央に配置
- クリーンで直感的なUI
- 即座にゲームが開始される体験

#### 2.1.2 ラウンド制ゲームフロー（GeoGuessr式）
**ラウンド構成**: 1ゲーム = 5ラウンド（温泉宿5つ）

**各ラウンドの流れ**:
1. **画像表示**: 温泉宿の画像6枚を5秒間隔で表示
2. **推測タイム**: ユーザーが地図上にピンを置く
3. **即座結果**: ピン配置後、即座にスコアと距離を表示
4. **結果確認**: 正解位置、推測位置、線で結んで表示
5. **次ラウンド**: 「次のラウンドへ」ボタンで進行

**最終結果**: 5ラウンド終了後、合計スコアと詳細結果を表示

#### 2.1.3 ゲームモード（GeoGuessr完全模倣）
**Classic（クラシック）**: 標準の5ラウンド制ゲーム
- 移動・回転・ズーム可能
- 制限時間なし
- 5000点満点/ラウンド

**No Move（ノームーブ）**: 移動不可モード
- 初期位置から移動不可
- 回転・ズームは可能
- より高難易度

**No Move, No Pan, No Zoom (NMPZ)**: 完全固定モード
- 移動・回転・ズーム全て不可
- 最高難易度
- 競技プレイ向け

**Time Limited（時間制限）**: スピード勝負
- 30秒、60秒、120秒から選択
- 時間切れで自動的に0点

**Streaks（ストリークス）**: 連続正解チャレンジ（将来実装）
- 都道府県を当て続ける
- 間違えるまで継続
- 連続正解数がスコア

**Battle Royale（バトルロイヤル）**: サバイバル形式（将来実装）
- 複数プレイヤーで同時対戦
- 各ラウンドで下位脱落
- 最後の1人が勝利

**Duels（デュエル）**: 1対1対戦（将来実装）
- リアルタイム対戦
- レーティング制
- ランク付き/アンランク選択可

#### 2.1.4 画像表示段階（温泉版アレンジ）
**段階1: 宿の画像表示**
- **🆕 実装済み**: 6枚の画像を5秒間隔で自動表示
- **画像内容**: 内装、外観、料理、露天風呂、町並み、夜景など
- **🆕 ケン・バーンズ効果**: 各画像で100%→105%のスローズーム（5秒間）
- **🆕 画像インジケーター**: 現在の画像位置を表示（例：3 / 6）
- **🆕 自動遷移**: 全画像表示後、推測フェーズに自動移行
- **GeoGuessrスタイル**: 画像は全画面表示、没入感重視

**段階1.5: 画像見直し機能（🆕 実装済み）**
- **手動ナビゲーション**: 全画像表示後、自由に画像を切り替え可能
- **操作方法**: 
  - 左右矢印ボタン（画面両端）
  - クリック可能ドットインジケーター（画面下部）
  - キーボード矢印キー（← →）
- **循環ナビゲーション**: 最後の画像から最初の画像へループ
- **無制限確認**: 推測するまで何度でも画像を見直し可能

**段階2: 衛星画像ヒント**
- 上空300mからの衛星画像を表示
- 10秒間でゆっくりズームアウト
- 周辺地形が見えるように
- **GeoGuessrスタイル**: Google Street View風の操作感

**段階3: 答え合わせ**
- 正解地点を地図上に表示
- 宿の詳細情報を表示
- **GeoGuessrスタイル**: 結果画面のアニメーション演出

#### 2.1.5 回答システム（GeoGuessr式）
- **地図UI**: 日本地図（一般的な地図、衛星画像なし）
- **ピン配置**: 地図上をクリックして推測地点を指定
- **ピン移動**: ドラッグでピンの位置を調整可能
- **即時判定**: ピン配置と同時に結果を表示
- **コンパス**: 方向感覚を助けるコンパス表示
- **グラフィック**: 正解位置（赤ピン）と推測位置（青ピン）を線で結ぶ

#### 2.1.6 操作コントロール（GeoGuessr模倣）

**画像内の移動操作**:
- **クリック移動**: 道路や通路をクリックして移動
- **ダブルクリック**: その地点へ高速移動
- **移動矢印**: 画面中央の矢印UI（前進・後退）
- **キーボード**: W/↑（前進）、S/↓（後退）、A/←（左旋回）、D/→（右旋回）

**視点操作**:
- **マウスドラッグ**: 360度視点回転
- **コンパス**: クリックで北向きにリセット
- **ズーム**: マウスホイール、+/-ボタン、Ctrl+スクロール

**地図操作**:
- **ズーム**: マウスホイール、ピンチ操作、+/-ボタン
- **パン**: ドラッグ操作で地図移動
- **リセット**: ホームボタンで全体表示に戻る
- **コンパスクリック**: コンパスクリックで北を上に固定
- **キーボードショートカット**: W/A/S/Dで地図移動、Spaceでピン配置

**GeoGuessrスタイルの地図操作**:
- **ズーム**: マウスホイールでスムーズなズーム
- **パン**: ドラッグで地図を移動
- **ピン**: クリックで即座に配置、ドラッグで移動可能
- **確定**: 「GUESS」ボタンで回答確定
- **地図レイヤー**: 地名表示のオン/オフ切り替え

#### 2.1.7 タイマー機能（🆕 実装済み）

**基本仕様**:
- **制限時間**: 60秒（画像1表示開始時にスタート）
- **カウントダウン**: リアルタイム表示（分:秒形式）
- **視覚的警告**: 残り10秒以下で赤色点滅

**タイマー表示**:
- **位置**: 画面上部中央
- **デザイン**: 半透明背景、白文字
- **警告表示**: 残り10秒以下で赤背景 + アニメーション

**時間切れ処理**:
- **自動結果表示**: 60秒経過で自動的に結果画面へ
- **スコア**: 0点（時間切れペナルティ）
- **表示**: "⏰ 時間切れ" + "推測できませんでした"
- **地図**: 正解位置のみ表示（緑ピン）、ユーザーピンなし

**手動推測時**:
- **タイマー停止**: ピン配置と同時にタイマー停止
- **通常処理**: 距離計算 + スコア表示
- **地図表示**: 青ピン（推測）+ 緑ピン（正解）+ 距離線

**タイマー管理**:
- **開始条件**: 最初の画像が表示された瞬間
- **停止条件**: 手動推測 OR 60秒経過
- **リセット**: 各ラウンド開始時に60秒にリセット

### 2.2 得点システム

#### 2.2.1 得点計算式（GeoGuessr模倣）
```
GeoGuessrスタイルの得点計算:
基本計算式:
Score = 5000 × e^(-distance/1492.7)

詳細:
- 0km = 5000点（満点）
- 1.5km = 4995点
- 5km = 4983点
- 10km = 4967点
- 25km = 4918点
- 50km = 4836点
- 100km = 4675点
- 250km = 4230点
- 500km = 3573点
- 1000km = 2554点
- 2000km = 1306点
- 5000km = 177点
- 10000km以上 = 0点

時間ボーナス（Time Limited モードのみ）:
- 残り時間50%以上: ×1.5倍
- 残り時間25%以上: ×1.25倍
- 残り時間25%未満: ×1.0倍
```

#### 2.2.2 得点の詳細（GeoGuessrスタイル）
- **最高得点**: 5000点/ラウンド（完璧な推測）
- **距離ペナルティ**: 距離に応じて減点
- **時間ボーナス**: 早く答えるほどボーナス
- **最低得点**: 0点（非常に遠い場合）
- **ラウンド合計**: 最大25,000点（5ラウンド）

#### 2.2.3 正解判定
- **正解**: 50km以内
- **完璧**: 5km以内
- **初回ボーナス**: 各宿で初回正解時に追加ポイント

### 2.3 答え合わせ画面

#### 2.3.1 結果表示アニメーション（GeoGuessr式）
1. **自動ズーム**: 地図が自動的に2点を含む範囲にズーム
2. **ライン描画**: 推測地点から正解地点へアニメーションで線を描画
3. **スコア表示**: カウントアップアニメーションでスコア表示
4. **距離表示**: 「You were ○○km away」形式で表示

#### 2.3.2 表示内容
1. **結果表示**
   - 獲得スコア
   - 距離（km）
   - 正解/不正解
   - 時間倍率

2. **地図表示**
   - 正解位置（赤ピン）
   - 推測位置（青ピン）
   - 2点間の距離を線で表示

3. **宿情報**
   - 宿名
   - 所在地（都道府県・市区町村）
   - 特徴・売り

4. **アクション**
   - 楽天トラベル予約リンク（アフィリエイト）
   - 宿を保存（ブックマーク）
   - 次のゲームに進む

#### 2.3.3 特典ランキング
- その宿の人気特典TOP5を表示
- 例：「露天風呂」「料理」「アクセス」など

## 3. ユーザー機能

### 3.1 ユーザー管理

#### 3.1.1 ユーザー識別
- **ローカルストレージ**: 初回アクセス時にユーザーIDを自動生成
- **永続化**: ユーザー情報をデータベースに保存
- **将来拡張**: Google OAuth連携でアカウント統合

#### 3.1.2 ユーザーデータ
- **累計スコア**: 全ゲームの合計得点
- **総プレイ回数**: ゲーム実行回数
- **保存した宿**: ブックマークした宿一覧
- **アバター設定**: カスタマイズ情報

### 3.2 ランキング機能

#### 3.2.1 週間ランキング
- **期間**: 直近1週間（月曜日起算）
- **対象**: 全ユーザーの累計得点
- **表示**: TOP20位まで表示
- **更新**: リアルタイム更新

#### 3.2.2 宿別ランキング
- **対象**: 特定の宿での最高得点
- **表示**: その宿での上位10名
- **更新**: 新記録時に即時更新

#### 3.2.3 グローバルランキング（将来実装）
- **総合ランキング**: 全期間の累計スコア
- **月間ランキング**: 当月のスコア集計
- **モード別ランキング**: Classic、No Move、NMPZ別
- **レベル別表示**: ブロンズ、シルバー、ゴールド、マスター

#### 3.2.4 フレンドランキング（将来実装）
- **フレンド間比較**: フレンドとのスコア比較
- **相対順位表示**: フレンド内での順位
- **週間チャレンジ**: フレンド間の週間競争

### 3.3 保存機能

#### 3.3.1 宿の保存
- **保存タイミング**: 答え合わせ画面で「保存」ボタン
- **保存理由**: 「行ってみたい」「気に入った」など
- **保存上限**: 制限なし

#### 3.3.2 保存宿一覧
- **アクセス**: メニューから「保存した宿」
- **表示内容**: 宿名、画像、所在地、保存日時
- **アクション**: 楽天トラベルリンク、保存解除

### 3.4 アバターシステム

#### 3.4.1 ポイント制度
- **ポイント獲得**: ゲームプレイ、初回正解など
- **ポイント用途**: アバターアイテム購入
- **ポイント種類**: ゲーム得点とは別管理

#### 3.4.2 カスタマイズ
- **アバター**: 基本キャラクター
- **服装**: 和服、洋服、作務衣など
- **アクセサリー**: 帽子、眼鏡、バッグなど
- **背景**: 温泉地の風景など

### 3.5 プログレッションシステム（GeoGuessr式）

#### 3.5.1 レベルシステム
- **XP獲得**: プレイごとに経験値獲得
- **レベルアップ**: 1〜100レベル
- **レベル報酬**: 新アバターアイテム、称号

#### 3.5.2 実績・バッジ
- **距離実績**: 「ピンポイント」（5m以内）、「名人」（100m以内）
- **連続実績**: 「5連続正解」「10連続正解」
- **地域実績**: 「東日本制覇」「西日本制覇」「全国制覇」
- **特殊実績**: 「初日の出」（元旦プレイ）、「満月の夜」（満月にプレイ）

#### 3.5.3 称号システム
- **初心者**: 温泉見習い
- **中級者**: 温泉通
- **上級者**: 温泉マイスター
- **達人**: 温泉仙人

## 4. UI/UX仕様

### 4.1 画面構成

#### 4.1.1 メイン画面（GeoGuessrスタイル）
- **ヘッダー**: ロゴ、メニュー、ユーザー情報
- **ゲームエリア**: 画像表示、地図、操作ボタン
- **サイドバー**: スコア、タイマー、ヒント

**GeoGuessrの画面レイアウト踏襲**:
- **左側**: 全画面画像表示エリア（60%）
- **右側**: 地図エリア（40%）
- **下部**: 操作ボタン（「GUESS」「NEXT」など）
- **上部**: スコア・タイマー・ラウンド情報

#### 4.1.2 レスポンシブ対応
- **デスクトップ**: 地図と画像を並列表示（GeoGuessrスタイル）
- **タブレット**: 地図と画像を上下配置
- **スマートフォン**: 単一画面で切り替え表示

### 4.2 操作性

#### 4.2.1 HUD（ヘッドアップディスプレイ）要素
**画像表示エリア（左側）**:
- **コンパス**: 右上に常時表示、クリックで北向きリセット
- **ズームバー**: 右側に縦型ズームコントロール
- **移動矢印**: 中央下部に前進・後退矢印
- **フルスクリーンボタン**: 右下に表示切り替え
- **画像切り替えボタン**: 温泉画像の手動切り替え（左右矢印）
- **ラウンド表示**: 左上に「Round 1/5」形式

**地図エリア（右側）**:
- **ズームコントロール**: +/-ボタン
- **地図タイプ切り替え**: 通常/衛星画像切り替え
- **GUESSボタン**: 大きな緑色のボタン、ピン配置後に有効化
- **リセットボタン**: 地図を日本全体表示に戻す

#### 4.2.2 地図操作（GeoGuessrスタイル）
- **ズーム**: マウスホイール、ピンチ操作
- **パン**: ドラッグ操作
- **ピン配置**: クリック/タップで配置
- **ピン移動**: ドラッグで移動可能
- **地図切り替え**: 衛星画像/地図の切り替えボタン
- **レイヤー**: 地名表示のオン/オフ

**GeoGuessrの操作感を完全模倣**:
- **直感的なピン配置**: クリックで即座に配置
- **スムーズなズーム**: 段階的でなく連続的
- **精密な移動**: ドラッグでの細かい調整が可能
- **ワンクリック確定**: 「GUESS」ボタンで即座に判定

#### 4.2.3 画像操作
- **自動再生**: 5秒間隔で自動切り替え
- **手動操作**: 前後ボタンで任意切り替え
- **一時停止**: 画像をじっくり見たい時
- **フルスクリーン**: 画像の拡大表示

### 4.3 フィードバック

#### 4.3.1 視覚的フィードバック（GeoGuessrスタイル）

**ピン配置時**:
- **ピンドロップアニメーション**: 上から落ちてくるアニメーション
- **波紋エフェクト**: ピン配置地点に波紋
- **音声フィードバック**: 「ポン」という配置音

**結果表示時**:
- **正解時**: 緑色のアニメーション
- **不正解時**: 赤色のアニメーション
- **スコア表示**: 数値のカウントアップ演出
- **距離線**: 推測地点と正解地点を結ぶライン
- **結果表示**: ポップアップモーダルでの詳細表示

**GeoGuessrの演出を踏襲**:
- **ピン落下**: 配置時のアニメーション
- **ズーム演出**: 正解地点への自動ズーム
- **スコア演出**: 獲得スコアのカウントアップ
- **距離表示**: 「○○km away」の表示

#### 4.3.2 音響フィードバック
- **正解音**: 心地よい効果音
- **不正解音**: 残念な効果音
- **BGM**: 和風の落ち着いた音楽
- **UI音**: ボタンクリック、ピン配置の効果音

## 5. 拡張機能

### 5.1 メタゲーム要素（推測のヒント）

#### 5.1.1 温泉地特有のヒント
- **看板・標識**: 温泉名、源泉名、効能書き
- **建築様式**: 地域特有の建築（飛騨造り、京町家風など）
- **植生**: 地域特有の植物（桜、紅葉、竹林など）
- **地形**: 山間部、海沿い、平野部の特徴
- **温泉街の雰囲気**: 石畳、街灯、商店街の様子

#### 5.1.2 推測テクニック
- **文字情報**: 看板の地名、電話番号の市外局番
- **車のナンバー**: 地域ナンバーから都道府県を推測
- **方言・訛り**: スタッフの言葉遣いから地域を推測（音声付き画像の場合）
- **料理**: 地域特産品、郷土料理から推測
- **景観**: 山の形、海岸線、有名な景勝地

### 5.2 ソーシャル機能（将来実装）
- **友達対戦**: 同じ宿で得点を競う
- **シェア機能**: 結果をSNSでシェア
- **コメント機能**: 宿に対するコメント

### 5.3 学習機能（将来実装）
- **解説モード**: 温泉地の歴史・特徴を説明
- **クイズモード**: 温泉に関する雑学クイズ
- **達成度**: 都道府県別の正解率

### 5.4 収益機能

#### 5.4.1 基本収益モデル
- **無料プレイ**: 1日3ゲームまで
- **プレミアム会員**: 月額500円で無制限プレイ
- **アフィリエイト**: 楽天トラベル予約で収益

#### 5.4.2 追加収益源
- **アフィリエイト**: 楽天トラベル予約リンク
- **広告表示**: 温泉関連の広告
- **プレミアム機能**: 有料での追加機能

### 5.5 競技・エスポーツ機能（将来実装）

#### 5.5.1 トーナメントシステム
- **定期大会**: 月例トーナメント
- **特別大会**: 季節イベント（桜の湯、紅葉の湯など）
- **賞品**: 実際の温泉宿泊券、グッズ

#### 5.5.2 リーグシステム
- **ブロンズリーグ**: 初心者向け
- **シルバーリーグ**: 中級者向け
- **ゴールドリーグ**: 上級者向け
- **マスターリーグ**: 最上位プレイヤー

#### 5.5.3 観戦機能
- **ライブ観戦**: トッププレイヤーの対戦を観戦
- **リプレイ**: 過去の名勝負を再生
- **解説モード**: 上級者の推測プロセスを学習

## 6. 成功指標

### 6.1 ユーザー指標
- **DAU**: 日次アクティブユーザー数
- **MAU**: 月次アクティブユーザー数
- **継続率**: 1日後、7日後、30日後の継続率

### 6.2 エンゲージメント指標
- **平均プレイ時間**: 1セッションあたりの時間
- **ゲーム回数**: 1セッションあたりのゲーム回数
- **保存率**: 宿を保存する割合

### 6.3 収益指標
- **CVR**: アフィリエイトリンクのクリック率
- **ARPU**: ユーザー1人あたりの平均収益
- **LTV**: ユーザーの生涯価値

## 7. 今後の展開

### 7.1 短期目標（3ヶ月）
- **基本機能**: ゲーム機能の完成
- **初期データ**: 100宿以上の登録
- **ユーザー獲得**: 1000人の登録

### 7.2 中期目標（6ヶ月）
- **機能拡張**: ランキング、アバター機能
- **データ拡充**: 500宿以上の登録
- **収益化**: アフィリエイト収益の発生

### 7.3 長期目標（1年）
- **ユーザー拡大**: 10000人の登録
- **機能充実**: ソーシャル機能の追加
- **事業化**: 持続可能な収益モデル
